{% extends "base.html" %}

{% block content %}
<div class="animate-fade-in max-w-4xl mx-auto h-[calc(100vh-120px)] flex flex-col">
    <header class="mb-6 flex justify-between items-center border-b border-brandBorder/50 pb-4">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('messages_inbox') }}"
                class="w-10 h-10 rounded-full bg-brandSidebar flex items-center justify-center hover:bg-brandBorder transition-colors group">
                <i class="ph ph-arrow-left text-gray-400 group-hover:text-white text-lg"></i>
            </a>

            <a href="{{ url_for('portfolio', user_id=other_user.id) }}" class="flex items-center gap-3 group">
                <div class="w-12 h-12 rounded-full overflow-hidden bg-gray-700">
                    {% if other_user.profile_image == 'default_profile.jpg' %}
                    <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=150&auto=format&fit=crop"
                        class="w-full h-full object-cover">
                    {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + other_user.profile_image) }}"
                        class="w-full h-full object-cover">
                    {% endif %}
                </div>
                <div>
                    <h2 class="text-xl font-bold group-hover:text-brandAccent transition-colors">{{ other_user.full_name
                        }}</h2>
                    <p class="text-xs text-green-400 flex items-center gap-1"><span
                            class="w-2 h-2 rounded-full bg-green-400 inline-block animate-pulse"></span> Active</p>
                </div>
            </a>
        </div>
    </header>

    <div class="bg-brandCard border border-brandBorder rounded-xl shadow-lg flex-1 flex flex-col overflow-hidden">

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6">
            {% if messages %}
            {% for message in messages %}
            {% if message.sender_id == current_user.id %}
            <!-- Sent Message -->
            <div class="flex flex-col items-end animate-slide-up">
                <div class="bg-brandAccent text-brandBase rounded-2xl rounded-tr-sm px-5 py-3 max-w-[80%] shadow-md">
                    <p class="text-sm font-medium">{{ message.content }}</p>
                </div>
                <span class="text-[10px] text-gray-500 mt-1">{{ message.timestamp.strftime('%I:%M %p') }}</span>
            </div>
            {% else %}
            <!-- Received Message -->
            <div class="flex flex-col items-start animate-slide-up">
                <div class="flex items-end gap-2 max-w-[80%]">
                    <div class="w-6 h-6 rounded-full overflow-hidden bg-gray-700 flex-shrink-0 mb-1 hidden sm:block">
                        {% if other_user.profile_image == 'default_profile.jpg' %}
                        <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=150&auto=format&fit=crop"
                            class="w-full h-full object-cover">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/' + other_user.profile_image) }}"
                            class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div
                        class="bg-brandSidebar border border-brandBorder text-white rounded-2xl rounded-tl-sm px-5 py-3 shadow-sm">
                        <p class="text-sm">{{ message.content }}</p>
                    </div>
                </div>
                <span class="text-[10px] text-gray-500 mt-1 ml-8 sm:ml-10">{{ message.timestamp.strftime('%I:%M %p')
                    }}</span>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <!-- Empty State -->
            <div class="h-full flex flex-col items-center justify-center text-center opacity-50">
                <i class="ph ph-hand-waving text-4xl mb-3"></i>
                <p class="text-sm">Say hello to {{ other_user.full_name }}!</p>
            </div>
            {% endif %}
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-brandSidebar border-t border-brandBorder/50">
            <form action="{{ url_for('chat', user_id=other_user.id) }}" method="POST" class="flex gap-3" id="chat-form">
                <input type="text" name="content" id="message-input" autocomplete="off" placeholder="Type a message..."
                    required
                    class="flex-1 bg-brandBase border border-brandBorder rounded-full px-5 py-3 text-sm focus:outline-none focus:border-brandAccent focus:ring-1 focus:ring-brandAccent transition-all placeholder-gray-500 shadow-inner">
                <button type="submit"
                    class="w-12 h-12 rounded-full bg-brandAccent hover:bg-brandAccentHover text-brandBase flex items-center justify-center shadow-md transition-transform active:scale-95">
                    <i class="ph-fill ph-paper-plane-right text-lg"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();

    socket.on('connect', () => {
        socket.emit('join', {});
    });
    // 1. Scroll to bottom on load
    const chatContainer = document.getElementById('chat-container');
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    // Need a tiny timeout to ensure rendering is complete before scrolling
    setTimeout(scrollToBottom, 50);

    // 2. Real-time Polling Logic
    const otherUserId = "{{ other_user.id }}";
    const currentUserId = "{{ current_user.id }}";

    // We only poll for messages newer than what we have on load.
    // Instead of using complex date parsing in JS, we just rely on server time via API.
    // Let's grab the current timestamp (in seconds) right now to use as "since"
    let lastPollTime = Math.floor(Date.now() / 1000);

    function formatTimeNow() {
        const now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0' + minutes : minutes;
        return hours + ':' + minutes + ' ' + ampm;
    }

    function appendMessage(content, timestamp, isSender) {
        // Quick visual clear of empty state if it exists
        const emptyState = chatContainer.querySelector('.opacity-50');
        if (emptyState) emptyState.remove();

        const msgDiv = document.createElement('div');
        msgDiv.className = isSender ? 'flex flex-col items-end animate-fade-in' : 'flex flex-col items-start animate-fade-in';

        let innerHtml = '';
        if (isSender) {
            innerHtml = `
                <div class="bg-brandAccent text-brandBase rounded-2xl rounded-tr-sm px-5 py-3 max-w-[80%] shadow-md">
                    <p class="text-sm font-medium">${content}</p>
                </div>
                <span class="text-[10px] text-gray-500 mt-1">${timestamp}</span>
            `;
        } else {
            innerHtml = `
                <div class="flex items-end gap-2 max-w-[80%]">
                    <div class="w-6 h-6 rounded-full overflow-hidden bg-gray-700 flex-shrink-0 mb-1 hidden sm:block">
                        {% if other_user.profile_image == 'default_profile.jpg' %}
                        <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=150&auto=format&fit=crop" class="w-full h-full object-cover">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/' + other_user.profile_image) }}" class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div class="bg-brandSidebar border border-brandBorder text-white rounded-2xl rounded-tl-sm px-5 py-3 shadow-sm">
                        <p class="text-sm">${content}</p>
                    </div>
                </div>
                <span class="text-[10px] text-gray-500 mt-1 ml-8 sm:ml-10">${timestamp}</span>
            `;
        }

        msgDiv.innerHTML = innerHtml;
        chatContainer.appendChild(msgDiv);
        scrollToBottom();
    }

    // 2. WebSocket Listener for Instant Messages
    socket.on('receive_message', (data) => {
        // Only append if the message is from the user we are currently chatting with
        if (Number(data.sender_id) === Number(otherUserId)) {
            appendMessage(data.content, data.timestamp, false);
        }
    });

    // 3. Handle Form Submission via AJAX
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');

    chatForm.addEventListener('submit', async function (e) {
        e.preventDefault(); // Prevent full page reload

        const content = messageInput.value.trim();
        if (!content) return;

        // Optimistically clear input
        messageInput.value = '';

        try {
            const response = await fetch(`/messages/${otherUserId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ content: content })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.status === 'success') {
                    // Instantly append the message we just sent to our own UI
                    appendMessage(data.message.content, data.message.timestamp, true);
                }
            } else {
                console.error("Failed to send message", await response.text());
                // Optionally restore the message input if it failed
                messageInput.value = content;
            }
        } catch (error) {
            console.error("Network error sending message:", error);
            messageInput.value = content;
        }
    });

</script>
{% endblock %}